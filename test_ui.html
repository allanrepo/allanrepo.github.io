<!DOCTYPE HTML>
<!--

goals
-   button
    -   design based on frame class
    -   mouse over/leave transparency animation
    -   



-->
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Sprite and Sprites Demo</title>
    <script type="text/javascript" src = "./js/scene.js"></script>
    <script type="text/javascript" src = "./js/ui.js"></script>

    <script type="text/javascript">
        'use strict'

        var myScene;

        /*------------------------------------------------------------------------------------------------------------
        console logger for ui event handlers
        ------------------------------------------------------------------------------------------------------------*/
        function attachConsoleLogger(element)
        {
            element.addEventListener("mousemove", function(e){ console.log(e.name + " " + "mousemove"); });
            element.addEventListener("mouseup", function(e){ console.log(e.name + " "  + "mouseup"); });
            element.addEventListener("mousedown", function(e){ console.log(e.name + " "  + "mousedown"); });
            element.addEventListener("mouseenter", function(e){ console.log(e.name + " "  + "mouseenter"); });
            element.addEventListener("mouseleave", function(e){ console.log(e.name + " "  + "mouseleave"); });
            element.addEventListener("mouseout", function(e){ console.log(e.name  + " " + "mouseout"); });
            element.addEventListener("mousedrag", function(e){ console.log(e.name + " "  + "mousedrag"); });
            element.addEventListener("mouseover", function(e){ console.log(e.name + " "  + "mouseover"); });
        }

        /*------------------------------------------------------------------------------------------------------------
        event handlers for rendering ui 
        ------------------------------------------------------------------------------------------------------------*/
        function drawSliderThumb(e)
        {
            myScene.shadowBlur = 0;
            myScene.drawRectangle( e.x, e.y, e.w, e.h, "rgba(255, 255, 255, 1)");            
        }

        function drawSliderBG(e)
        {
            myScene.shadowBlur = 0;
            myScene.drawRectangle( e.x, e.y, e.w, e.h, "rgba(32, 32, 32, 0.5)");            
        }

        function drawFrameBG(e)
        {
            // draw frame background
            myScene.shadowColor = "black";
            myScene.shadowBlur = 10;
            myScene.drawRectangle(e.x, e.y, e.w, e.h, "rgba(192, 192, 192, " + 0.5 + ")");
        }

        /*------------------------------------------------------------------------------------------------------------
        frame for testing
        ------------------------------------------------------------------------------------------------------------*/
        function myTestFrame(parent, name, x, y, w, h)        
        {
            // declare variable to store content information
            var content = { width: 0, height: 0 }

            // build frame
            var frame = new Frame(parent, name, x, y, w, h, false, false, false);

            // draw frame
            frame.addEventListener("draw", drawFrameBG); // draw frame background
            frame.addEventListener("draw", function(e)
            {
                // draw content for visualization
                myScene.shadowBlur = 0;
                myScene.drawRectangle(e.x - frame.hs.value, e.y - frame.vs.value, content.width, content.height, "rgba(128, 128, 255, 0.5)", {bordercolor: "rgba(192, 192, 192, 0.5)",borderwidth:1} );

                // draw debug info
                myScene.drawText("value: " + frame.vs.value, e.x + 5, e.y + 5, 0, 0, 20, "courier", "rgb(255,255,255)");
                myScene.drawText("max: " + frame.vs.max, e.x + 5, e.y + 25, 0, 0, 20, "courier", "rgb(255,255,255)");
                myScene.drawText(content.width + ", " + content.height, e.x + 5, e.y + 45, 0, 0, 20, "courier", "rgb(255,255,255)");
                myScene.drawText(frame.width + ", " + frame.height, e.x + 5, e.y + 65, 0, 0, 20, "courier", "rgb(255,255,255)");
            }); 

            // when mouse is dragged on frame, update position of slider based on the drag value
            frame.addEventListener("mousedrag", function(e)
            {
                // shift slider's value. this will trigger slider's onchange() event where we will handle update to thumb size
                frame.vs.value -= e.dy; 
                frame.hs.value -= e.dx;                 
            });                   

            // slider thickness 
            frame.t = 32; 

            // build our sliders
            frame.vs = new Slider(frame, "vslider", true, frame.width - frame.t, 0, frame.t, frame.height - frame.t, 0, 0, 1);
            frame.hs = new Slider(frame, "hslider", false, 0, frame.height - frame.t, frame.width - frame.t, frame.t, 0, 0, 1);

            // draw sliders
            frame.vs.addEventListener("drawthumb", drawSliderThumb); // draw vs thumb
            frame.vs.addEventListener("draw", drawSliderBG); // draw vs background
            frame.hs.addEventListener("drawthumb", drawSliderThumb); // draw vs thumb
            frame.hs.addEventListener("draw", drawSliderBG); // draw vs background

            /*
            content.w < frame.w - slider.t | content.w < frame.w | content.h < frame.h - slider.t | content.h < frame.h | h.slider.hide | v.slider.hide -- 0
            content.w < frame.w - slider.t | content.w < frame.w | content.h > frame.h - slider.t | content.h < frame.h | h.slider.hide | v.slider.hide -- 0
            content.w > frame.w - slider.t | content.w < frame.w | content.h < frame.h - slider.t | content.h < frame.h | h.slider.hide | v.slider.hide -- 0
            content.w > frame.w - slider.t | content.w < frame.w | content.h > frame.h - slider.t | content.h < frame.h | h.slider.hide | v.slider.hide -- 0

            content.w < frame.w - slider.t | content.w < frame.w | content.h > frame.h - slider.t | content.h > frame.h | h.slider.hide | v.slider.show -- 1
            content.w > frame.w - slider.t | content.w > frame.w | content.h < frame.h - slider.t | content.h < frame.h | h.slider.show | v.slider.hide -- 1

            content.w > frame.w - slider.t | content.w > frame.w | content.h > frame.h - slider.t | content.h < frame.h | h.slider.show | v.slider.show -- 1, 2
            content.w > frame.w - slider.t | content.w < frame.w | content.h > frame.h - slider.t | content.h > frame.h | h.slider.show | v.slider.show -- 1, 2
            content.w > frame.w - slider.t | content.w > frame.w | content.h > frame.h - slider.t | content.h > frame.h | h.slider.show | v.slider.show -- 1
            */           

            // to be called when content.size change. the following need to be done:
            //  - we decide if we need sliders based on new content.size and current frame.size
            //  - update sliders' sizes. sliders are supposed to fit into the frame.
            //  - update max sliders' max values. max values represent on content.size
            //  - update sliders' thumbsize
            //  - if there's an expected min thumbsize, ensure we don't set it below min
            function onChange()
            {
                // decide if we need sliders based on new content size. default is they are hidden
                // we update both h and v sliders even when only content.width is changed as it's possible that both sliders
                // will hide/show based on the change in content.width alone
                frame.hs.hide = true; // 0
                frame.vs.hide = true; // 0
                if (content.width > frame.width) frame.hs.hide = false; // 1
                if (content.height > frame.height) frame.vs.hide = false; // 1
                if ((content.width > frame.width - frame.t) && (content.height > frame.height)){ frame.hs.hide = false; } // 2
                if ((content.height > frame.height - frame.t) && (content.width > frame.width)){ frame.vs.hide = false; } // 2

                // now that we know which slider(v/s) is enabled, update their sizes
                // we set a rule that sliders will try to fill frame size. e.g. if vslider is hidden, hslider.height = frame.height
                // both h and s sliders to be updated as it's possible that both slides will hide/show based on change in content.width alone
                if (!frame.hs.hide){ frame.hs.width = frame.width - (frame.vs.hide? 0 : frame.t); }
                if (!frame.vs.hide){ frame.vs.height = frame.height - (frame.hs.hide? 0 : frame.t); }

                // set slider's min/max. max value is calculated as the value difference between content size and display size.
                // the excess size of content will be the scroll size of slider. if content size < display size, max < 0 but slider class will 
                // handle this properly and fix the thumbsize and its position to ensure no undesired behavior occurs
                // since both h and s sliders might have hide/show from this change, update max for both sliders
                frame.vs.min = 0; // min = 0, default.
                frame.hs.min = 0; // min = 0, default.
                frame.vs.max = content.height - frame.height + (frame.hs.hide? 0 : frame.t);
                frame.hs.max = content.width - frame.width + (frame.vs.hide? 0 : frame.t);

                // we want thumbsize to be based on ratio between content.size and frame.size. slider size is expected to fill frame size
                // but if both sliders (h and v), slider.size = frame.size - slider.t 
                // since both v and h sliders might have changed their sizes, we update both thumbsize
                frame.vs.thumbsize = frame.height / content.height * (frame.vs.height - (frame.hs.hide? 0 : frame.t));
                frame.hs.thumbsize = frame.width  / content.width  * (frame.hs.width  - (frame.vs.hide? 0 : frame.t));

                // let's set min value for thumbsize, 32, because if content.size is too big, thumbsize will be too small to click.
                if (frame.vs.thumbsize < 32) frame.vs.thumbsize = 32;
                if (frame.hs.thumbsize < 32) frame.hs.thumbsize = 32;
            }

            // handle content.width change
            Object.defineProperty(frame, "contentwidth", 
            { 
                get: function(){ return content.width; }, 
                set: function(e)
                {                    
                    content.width = e; // update content size variable with new value                    
                    onChange(); // when content.size change, this will handle updates to sliders' state, size, max, and thumbsize
                }
            });

            // handle content.height change
            Object.defineProperty(frame, "contentheight", 
            { 
                get: function(){ return content.height; }, 
                set: function(e)
                {
                    content.height = e; // update content size variable with new value
                    onChange(); // when content.size change, this will handle updates to sliders' state, size, max, and thumbsize
                }
            });

            frame.addEventListener("resize", function(e)
            {
                // reposition sliders 
                frame.vs.x = frame.width - frame.t;
                frame.vs.y = 0;
                frame.hs.x = 0
                frame.hs.y = frame.height - frame.t;

                onChange(); // when content.size change, this will handle updates to sliders' state, size, max, and thumbsize
            }); 


            // default
            frame.contentwidth = 0;
            frame.contentheight =0;

            return frame;
        }        

        /*------------------------------------------------------------------------------------------------------------
        slider for testing
        ------------------------------------------------------------------------------------------------------------*/
        function mySlider(parent, name, vertical, x, y, w, h, t, min, max)
        {
            var s = new Slider(parent, name, vertical, x, y, w, h, t, min, max);
            s.addEventListener("drawthumb", drawSliderThumb); // draw vs thumb
            s.addEventListener("draw", drawSliderBG); // draw vs background

            return s;
        }

        /*------------------------------------------------------------------------------------------------------------
        this will be our container class
        ------------------------------------------------------------------------------------------------------------*/
        function myContainer(parent, name, x, y, w, h)
        {
            var t = 24; // slider thickness

            // cannot be dragged
            var frame = new Frame(parent, name, x, y, w, h, false, false, false);

            // inner box where content will be stored
            var box = new Frame(frame, name + "_box", 0, 0, w - t, h - t, false, false, false);
            box.cx = 0;
            box.cy = 0;
            box.cw = 400;
            box.ch = 400;

            // vertical slider            
            var vs = new Slider(frame, name + "_vs", true, w - t, 0, t, h - t, 0, 0, 10, false);
            vs.addEventListener("drawthumb", drawSliderThumb); // draw vs thumb
            vs.addEventListener("draw", drawSliderBG); // draw vs background
            
            // horizontal slider            
            var ws = new Slider(frame, name + "_ws", false, 0, h - t, w - t, t, t, 0, 10, false);
            ws.addEventListener("drawthumb", drawSliderThumb); // draw vs thumb
            ws.addEventListener("draw", drawSliderBG); // draw vs background


            // define draw event handler
            frame.addEventListener("draw", function(e)
            {
                myScene.shadowBlur = 0;                
                myScene.drawRectangle(e.x, e.y, e.w , e.h, "rgba(128, 128, 128, 255)");//, {radius:3, topleft: true, btmleft: true, topright: true, btmright: true});
            });             


            // define draw event handler
            box.addEventListener("draw", function(e)
            {
                myScene.shadowBlur = 0;                

                myScene.drawRectangle( e.x + e.elem.cx, e.y + e.elem.cy, e.elem.cw, e.elem.ch, "rgba(128, 128, 255, 0.5)", {bordercolor: "rgba(192, 192, 192, 0.5)",borderwidth:1} );
            }); 

            // define draw event handler
            box.addEventListener("mousedrag", function(e)
            {
                e.elem.cx += e.dx;
                e.elem.cy += e.dy;

                if (e.elem.cx < e.elem.width - e.elem.cw) e.elem.cx = e.elem.width - e.elem.cw;
                if (e.elem.cx > 0) e.elem.cx = 0;

                if (e.elem.cy < e.elem.height - e.elem.ch) e.elem.cy = e.elem.height - e.elem.ch;
                if (e.elem.cy > 0) e.elem.cy = 0;
            });             

            return box;
        }


        /*------------------------------------------------------------------------------------------------------------
        this will be our drop-down button class
        ------------------------------------------------------------------------------------------------------------*/
        function myDropDown(parent, name, x, y, w, h)
        {
            // create frame as button
            var dp = new Frame(parent, name, x, y, w, h, false, false, false);

            // define draw event handler
            dp.addEventListener("draw", function(e)
            {
                myScene.shadowBlur = 0;                
                myScene.drawRectangle(e.x, e.y, e.w - e.h, e.h, "rgba(128, 128, 128, 255)", {radius:5, topleft: true, btmleft: true});
                myScene.drawRectangle(e.x + e.w - e.h, e.y, e.h, e.h, "rgba(192, 192, 192, 255)", {radius:5, topright: true, btmright: true});
            }); 

            // list box
            var lb = new Frame(null, name + "_lb", 0, 0, w, 300, false, false, false);
            lb.addEventListener("draw", function(e)
            {
                myScene.shadowBlur = 0;                
                myScene.drawRectangle(e.x, e.y, e.w, e.h, "rgba(128, 128, 128, 255)", {radius:5, topleft: true, btmleft: true, topright: true, btmright: true});
            }); 

            // get reference to root
            var root = dp.parent;
            while(root.parent)
            { 
                console.log(root.name);
                root = root.parent; 
            }
            console.log(root.name + " --");
        

            // define onmousedown event handler
            dp.addEventListener("mousedown", function(e)
            {                
                // get abs position of this ui
                var p = dp.getAbsPos();

                lb.x = p.x;
                lb.y = p.y + dp.height + 5;

                // add dropdown ui's list box to root's children list. make sure it's top child
                root.addChild(lb);
            });               


            return dp; 
        }


        /*------------------------------------------------------------------------------------------------------------
        this will be our button class
        ------------------------------------------------------------------------------------------------------------*/
        function myButton(text, parent, name, x, y, w, h)
        {
            // create frame as button
            var btn = new Frame(parent, name, x, y, w, h, false, false, false);

            // flag to tell if button is clicked or not
            var bClick = false; 

            // shift size if button is clicked
            var shift = 1; 

            //var alpha = 0;

            // define draw event handler
            btn.addEventListener("draw", function(e)
            {
                myScene.shadowBlur = 0;
                myScene.drawRectangle(e.x + (bClick? shift:0), e.y + (bClick? shift:0), e.w, e.h, "rgba(192, 192, 192, 255)", {radius:5, topright: true, btmright: true, btmleft:true, topleft:true});
            }); 
            return btn;
        }

        /*------------------------------------------------------------------------------------------------------------
        this will be our frame class
        ------------------------------------------------------------------------------------------------------------*/
        function myFrame(parent, name, x, y, w, h)
        {            
            // object that defines parameters for tooltip
            var tooltip = {};
            tooltip.state = false; // to draw or not to draw
            tooltip.x = x; // top-left pos
            tooltip.y = y; // top-left pos
            tooltip.drawTimer = 0; // delay counter before rendering it

            var a = 0.3;
            var f = new Frame(parent, name, x, y, w, h, true, true, false);
            //f.addEventListener("mouseenter", function(e){ a = 0.6; } );
            //f.addEventListener("mouseleave", function(e){ a = 0.3; } );
            f.addEventListener("draw", function(e)
            {
                // draw frame background
                myScene.shadowColor = "black";
                myScene.shadowBlur = 10;
                myScene.drawRectangle(e.x, e.y, e.w, e.h, "rgba(192, 192, 192, " + a + ")");

                // draw tooltip (beside mouse cursor)
                if (tooltip.state && tooltip.drawTimer >= 10)
                {
                    var s = 20; // font size
                    var b = 40; // border size
                    var o = 10; // top-left offset from mouse cursor
                    var m = 2; // tooltip box border margin size
                    var w = myScene.getTextWidth(e.name, "courier", s); 

                    myScene.shadowBlur = 0;
                    myScene.drawRectangle(tooltip.x + o - m, tooltip.y + o - m, w + b*2 + m*2, s + b/2 + m*2, "rgba(64, 64, 64, 255)", {bordercolor:"rgba(192, 192, 192, 255)", borderwidth:2, radius:3, topright: true, btmright: true, btmleft:true, topleft:true});
                    //myScene.drawRectangle(tooltip.x + o - m, tooltip.y + o - m, w + b*2 + m*2, s + b/2 + m*2, 3, "", "rgba(192, 192, 192, " + 0.5 + ")");
                    //myScene.drawRectangle(tooltip.x + o, tooltip.y + o, w + b*2, s + b/2, 3, "", "rgba(64, 64, 64, " + 0.5 + ")");
                    myScene.drawText(e.name, tooltip.x + o, tooltip.y + o, w + b*2, s + b/2, s, "courier", "rgb(255,255,255)", "center", "center");
                }             
            });      

            // event handler to update tooltip draw delay counter
            function drawToolTip(e)
            {
                tooltip.drawTimer += e.step;
                if (tooltip.drawTimer >= 10)
                {
                    tooltip.drawTimer = 10;
                    myScene.removeEvent(drawToolTip);
                }
            }
            
            // if mouse cursor intersects with this frame, enable tooltip
            f.addEventListener("mouseenter", function(e)
            {
                tooltip.drawTimer = 0; 
                myScene.addEvent(drawToolTip,100);
                tooltip.state = true;  
            });              
            f.addEventListener("mouseover", function(e)
            { 
                tooltip.drawTimer = 0;
                myScene.addEvent(drawToolTip,100);
                tooltip.state = true;  
            });              

            // if mouse cursor exits this frame, disable tooltip
            f.addEventListener("mouseleave", function(e)
            { 
                myScene.removeEvent(drawToolTip);
                tooltip.state = false; 
            });              
            f.addEventListener("mouseout", function(e)
            { 
                myScene.removeEvent(drawToolTip);
                tooltip.state = false; 
            });              

            // when mouse moves around this frame's extent, save mouse cursor coordinate
            f.addEventListener("mousemove", function(e){ tooltip.x = e.x; tooltip.y = e.y});              
            f.addEventListener("mousedrag", function(e)
            { 
                tooltip.x = e.x; tooltip.y = e.y
                myScene.removeEvent(drawToolTip);
                tooltip.state = false; 
            });              

            return f;
        }

        /*------------------------------------------------------------------------------------------------------------
        root class is no frills. let's inherit it and implement all the bells and wistles we want from our root 
        ------------------------------------------------------------------------------------------------------------*/
        function ui(parent)
        {
            // create root ui object and attach a draw event handler 
            ui = new Root(parent, "root");
            ui.addEventListener("draw", function(e)
            {
                parent.globalAlpha = 1;
                parent.shadowBlur = 0;
                parent.drawRectangle(0, 0, e.w, e.h, "rgba(64,64,64,255)");
            });	
            //attachConsoleLogger(ui);

            var f0 = new myFrame(ui, "frame0", 50, 50, 400, 300);
            f0.contentheight = new mySlider(f0, "ff", true, 5, 5, 32, 200, 32, 150, 800);
            f0.contentwidth = new mySlider(f0, "ff", true, 55, 5, 32, 200, 32, 100, 700);
            f0.containerwidth = new mySlider(f0, "ff", true, 105, 5, 32, 200, 32, 160, 600);
            f0.containerheight = new mySlider(f0, "ff", true, 155, 5, 32, 200, 32, 240, 400);

            var f1 = new myFrame(ui, "frame0", 50, 50, 600, 400);
            var f2 = new myTestFrame(f1, "test_slider", 0, 0, 300, 200);

            f0.contentheight.addEventListener("change", function(e){ f2.contentheight = e.val; });
            f0.contentwidth.addEventListener("change", function(e){ f2.contentwidth = e.val; });                   
            f0.containerheight.addEventListener("change", function(e){ f2.height = e.val; });
            f0.containerwidth.addEventListener("change", function(e){ f2.width = e.val; });                   

            return ui;

            var frm0 = new myFrame(ui, "hello world", 0, 0, 600, 400);
            //attachConsoleLogger(frm0);

            var frm1 = new myFrame(ui, "frame1", 5, 5, 400, 200);
            var t = 32;
            var sldr = new mySlider(frm1, "myslider", true, frm1.width - t, 0, t, frm1.height - t, t, 0, 9);
            //attachConsoleLogger(frm1);

            //var frm2 = new myFrame(frm0, "XXXX", 5, 5, 200, 150);
            //attachConsoleLogger(frm2);

            //var frm3 = new myFrame(frm0, "YYYY", 5, 185, 200, 150);
            //attachConsoleLogger(frm3);

            //var frm4 = new myFrame(frm2, "AA", 5, 5, 100, 40);
            //attachConsoleLogger(frm4);

            //var frm5 = new myFrame(frm2, "BB", 5, 55, 100, 40);
            //attachConsoleLogger(frm5);

            var box = new myContainer(frm0, "container", 10, 10, 320, 320);
            attachConsoleLogger(box);

            return ui;
        }

        /*------------------------------------------------------------------------------------------------------------
        event handler for <body> onload
        ------------------------------------------------------------------------------------------------------------*/
		function init()
		{		
			// create scene object
            myScene = new Scene("sim_canvas");	
            //myScene.x = 50;
            //myScene.y = 100;
            //myScene.width = 800;
            //myScene.height = 600;
            //myScene.autoFitDocument(false);

            // attach ui element to our scene
            myScene.ui = new ui(myScene);

            // add render loop in scene
            myScene.addEvent(render, 16.67);
            myScene.addEvent(run, 1);
            
            myScene.fps1 = 0;

			// run the scene
			myScene.start();		            
        }

        
		// application loop 
 		function render(e)    
		{
            myScene.clear();
            myScene.ui.draw();
            
			myScene.drawText("Scene class version " + myScene.version + "; Render(FPS): " + e.fps.toFixed(2) + ", " + "Run(FPS): " + myScene.fps1 + ", " + myScene.width + "x" + myScene.height, 5, 5, 0, 0, 20, "courier", "rgb(255,255,255)");
			myScene.drawText("NumEvents: " + myScene.getNumEvents(), 5, 35, 0, 0, 20, "courier", "rgb(255,255,255)");
            myScene.drawText("MouseMove UI: " + (myScene.ui.getMouseMove()? myScene.ui.getMouseMove().name:""), 5, 65, 0, 0, 20, "courier", "rgb(255,255,255)");
            
            //myScene.drawRectangle(100, 100, 300, 80, "rgba(64, 64, 64, 255)");//, {color:"rgba(192, 192, 192, 255)", width:5}, {radius:20, topright: true, btmright: true, btmleft:true, topleft:true});			
            
        }	
        
        function run(e)
        {
            myScene.fps1 = e.fps.toFixed(2);
        }
			
	</script>
</head>
<body onload = "init()" style="margin: 0">
    <canvas style="margin-left: left; margin-right: right; display: block; margin: 0;" id = "sim_canvas"  >
        Your browser does not support the HTML5 canvas tag.
    </canvas>
 </body>
</html>